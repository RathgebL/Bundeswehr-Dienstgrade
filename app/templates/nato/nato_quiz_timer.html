{% extends "base/base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/nato_quiz_timer.css') }}">
{% endblock %}

{% block content %}
<div class="nato-quiz-timer page-box">
  <h1 class="nato-quiz-timer__title heading-primary">Zeitmodus: NATO-Alphabet</h1>

  <p id="timer" class="quiz__timer d-none">Verbleibende Zeit: 60s</p>
  <p id="score" class="quiz__score d-none">Punkte: 0</p>

  <div class="quiz__content"></div>
</div>

<script>
let allNato = {{ nato_entries|tojson|safe }};
let gameOver = false;
let timeLeft = 60;
let score = 0;
let timerInterval;

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("timer").classList.remove("d-none");
  document.getElementById("score").classList.remove("d-none");

  shuffleQuestions();
  nextQuestion();
  startTimer();
});

// ---------------------
// TIMER
// ---------------------
function startTimer() {
  const timer = document.getElementById("timer");
  timer.innerText = "Verbleibende Zeit: " + timeLeft + "s";

  timerInterval = setInterval(() => {
    timeLeft--;
    timer.innerText = "Verbleibende Zeit: " + timeLeft + "s";

    if (timeLeft <= 10) timer.style.color = "var(--red)";
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      endGame();
    }
  }, 1000);
}

// ---------------------
// FRAGEPOOL
// ---------------------
let questionIndex = 0;
let shuffledNato = [];

function shuffleQuestions() {
  shuffledNato = [...allNato].sort(() => Math.random() - 0.5);
  questionIndex = 0;
}

// ---------------------
// FRAGENLOGIK
// ---------------------
function nextQuestion() {
  if (gameOver) return;

  if (questionIndex >= shuffledNato.length) shuffleQuestions();

  const correct = shuffledNato[questionIndex++];
  const wrongs = [
    correct.wrong1, correct.wrong2, correct.wrong3,
    correct.wrong4, correct.wrong5, correct.wrong6,
    correct.wrong7, correct.wrong8, correct.wrong9
  ].filter(Boolean);

  const wrongSelected = wrongs.sort(() => 0.5 - Math.random()).slice(0, 3);
  const options = [correct.correct, ...wrongSelected].sort(() => 0.5 - Math.random());

  renderQuestion(correct, options);
}

function renderQuestion(correct, options) {
  const container = document.querySelector(".quiz__content");
  container.innerHTML = `
    <div class="quiz__letter-box">
      <h1 class="quiz__letter">${correct.letter}</h1>
    </div>

    <div class="quiz__options">
      ${options.map(opt => `
        <button class="quiz__button" onclick="checkAnswer('${opt}', '${correct.correct}')">
          ${opt}
        </button>
      `).join("")}
    </div>

    <p id="feedback" class="quiz__feedback"></p>
  `;
}

function checkAnswer(selected, correct) {
  const buttons = document.querySelectorAll(".quiz__button");
  buttons.forEach(btn => btn.classList.add("is-locked"));
  const feedback = document.getElementById("feedback");

  if (selected === correct) {
    score++;
    document.getElementById("score").innerText = "Punkte: " + score;
    feedback.innerText = "Richtig!";
    const correctBtn = Array.from(buttons).find(b => b.textContent.trim() === correct);
    correctBtn?.classList.add("quiz__button--correct");
  } else {
    feedback.innerText = "Falsch!";
    const selectedBtn = Array.from(buttons).find(b => b.textContent.trim() === selected);
    const correctBtn = Array.from(buttons).find(b => b.textContent.trim() === correct);
    selectedBtn?.classList.add("quiz__button--wrong");
    correctBtn?.classList.add("quiz__button--correct");
  }

  setTimeout(nextQuestion, 800);
}

// ---------------------
// SPIELENDE
// ---------------------
function endGame() {
  clearInterval(timerInterval);
  gameOver = true;

  document.getElementById("timer").classList.add("d-none");
  document.getElementById("score").classList.add("d-none");

  const container = document.querySelector(".quiz__content");
  container.innerHTML = `
    <div class="quiz__end">
      <h2 class="quiz__end-title">Zeit abgelaufen!</h2>
      <p class="quiz__end-text">Du hast <strong>${score}</strong> Punkte erreicht.</p>
      <div class="quiz__end-buttons">
        <a href="/nato/quiz_timer" class="quiz__next">Erneut versuchen</a>
        <a href="{{ url_for('nato.nato_menu') }}" class="quiz__next">Zur√ºck</a>
      </div>
    </div>
  `;
}
</script>
{% endblock %}