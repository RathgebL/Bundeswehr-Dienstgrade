{% extends "base/base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles/pages/home.css') }}">
{% endblock %}

{% block content %}
<div class="page-box page--narrow">
  <h1 class="heading-primary">Dienstgrad erkennen</h1>

  <!-- Timer & Punktestand -->
  <p id="timer" class="quiz__timer d-none">Verbleibende Zeit: 60s</p>
  <p id="score" class="quiz__score d-none">Punkte: 0</p>

  <!-- Dynamischer Container -->
  <div class="quiz__content"></div>

  <a
  href="{{ url_for('ranks.ranks_quizmodes', branch=selected_branch, mode='normal') }}"
  class="btn btn--secondary w-260 d-none"> Zur端ck zum Men端 
  </a>
</div>

<script>
let allRanks = {{ ranks|tojson|safe }};
let timeLeft = 60;
let score = 0;
let timerInterval;
let questionLocked = false;
let gameEnded = false;

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("timer").classList.remove("d-none");
  document.getElementById("score").classList.remove("d-none");
  nextQuestion();
  startTimer();
});

function startTimer() {
  const timer = document.getElementById("timer");
  timer.innerText = "Verbleibende Zeit: " + timeLeft + "s";

  timerInterval = setInterval(() => {
    timeLeft--;
    timer.innerText = "Verbleibende Zeit: " + timeLeft + "s";

    if (timeLeft <= 10) {
      timer.style.color = "var(--color-red)";
    }

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      endGame();
    }
  }, 1000);
}

function nextQuestion() {
  if (gameEnded) return;
  questionLocked = false;

  const correct = allRanks[Math.floor(Math.random() * allRanks.length)];
  const wrong = allRanks.filter(r => r.id !== correct.id);
  const options = [correct, ...wrong.sort(() => 0.5 - Math.random()).slice(0, 3)];
  options.sort(() => 0.5 - Math.random());

  renderQuestion(correct, options);
}

function renderQuestion(correct, options) {
  const container = document.querySelector(".quiz__content");
  container.innerHTML = `
    <img src="/static/images/${correct.image_filename}" alt="${correct.title}" class="quiz__image mx-auto">

    <div class="btn-group">
      ${options.map(opt => `
        <button 
          class="btn btn--primary w-260 h-80" data-id="${opt.id}" 
          onclick="checkAnswer(${opt.id}, ${correct.id})">
          ${opt.title}
        </button>
      `).join("")}
    </div>

    <p id="feedback" class="heading-secondary"></p>
  `;
}

function checkAnswer(selectedId, correctId) {
  if (questionLocked || gameEnded) return;
  questionLocked = true;

  const feedback = document.getElementById("feedback");
  const buttons = document.querySelectorAll("button[data-id]");
  buttons.forEach(btn => btn.classList.add("is-locked"));

  if (selectedId === correctId) {
    score++;
    feedback.innerText = "Richtig!";
    document.getElementById("score").innerText = "Punkte: " + score;
    document.querySelector(`button[data-id="${selectedId}"]`).classList.add("btn--success");
  } else {
    feedback.innerText = "Falsch!";
    document.querySelector(`button[data-id="${selectedId}"]`).classList.add("btn--danger");
    document.querySelector(`button[data-id="${correctId}"]`).classList.add("btn--success");
  }

  if (!gameEnded && timeLeft > 0) setTimeout(nextQuestion, 500);
}

function endGame() {
  if (gameEnded) return;
  gameEnded = true;
  clearInterval(timerInterval);

  document.getElementById("timer").classList.add("d-none");
  document.getElementById("score").classList.add("d-none");

  const container = document.querySelector(".quiz__content");
  container.innerHTML = `
    <div class="quiz__end">
      <h2 class="heading-secondary">Zeit abgelaufen!</h2>
      <p Du hast <strong>${score}</strong> Punkte erreicht.</p>
      <div class="btn-group">
        <a href="{{ url_for('ranks.ranks_quizmodes') }}" class="btn btn--secondary w-200">Zur端ck zum Men端</a>
        <a href="{{ url_for('ranks.ranks_quiz1_timer') }}" class="btn btn--primary w-200">Erneut versuchen</a>
      </div>
    </div>
  `;
}
</script>
{% endblock %}