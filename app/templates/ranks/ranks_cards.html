{% extends "base/base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles/pages/home.css') }}">
{% endblock %}

{% block content %}
<div class="page-box page--narrow">
  <h1 class="heading-primary">Karteikarten</h1>

  <!-- Filter -->
  <form method="get" action="{{ url_for('ranks.ranks_cards') }}">
    <label class="select-label" for="branch">Truppenteil:</label>
    <select name="branch" id="branch" class="select select--small" onchange="this.form.submit()">
      {% for b in branches %}
      <option value="{{ b }}" {% if selected_branch == b %}selected{% endif %}>{{ b }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- Karte -->
  <div id="flashcard" class="flashcard card--small">
    <div class="card-flip" onclick="flipCard()">
        
      <!-- Vorderseite -->
      <div class="flashcard card__face">
        <img id="rank-image"
          src="{{ url_for('static', filename='images/' + ranks[0].image_filename) }}"
          alt="{{ ranks[0].title }}"
          class="card__image">
        <p class="card__hint">Klick zum Umdrehen</p>
      </div>  

      <!-- Rückseite -->
      <div class="flashcard card--small card__face card__face--back">
        <h4 id="rank-title" class="rank-title">{{ ranks[0].title }}</h4>
        <div id="rank-meta" class="rank-meta">
          <p id="rank-abbr">{{ ranks[0].abbreviation or "-" }}</p>
          <p id="rank-group">{{ ranks[0].rank_group or ranks[0].rank_type or "-" }}</p>
          <p id="rank-nato">{{ ranks[0].level_code or "-" }}</p>
        </div>
        <p id="rank-desc" class="rank-desc">{{ ranks[0].description }}</p>
      </div>
    </div>
  </div>

  <!-- Steuerung -->
  <div class="ranks-cards__buttons">
    <div class="btn-group">
      <button class="btn btn--primary btn--narrow" onclick="prevCard()">Vorherige Karte</button>
      <button class="btn btn--primary btn--narrow" onclick="nextCard()">Nächste Karte</button>
      <button class="btn btn--primary btn--narrow" onclick="shuffleCards()">Mischen</button>
      <button class="btn btn--primary btn--narrow" onclick="resetCards()">Ordnen</button>
    </div>
  </div>

  <!-- Zurück -->
  <a href="{{ url_for('ranks.ranks_menu') }}" class="btn btn--secondary btn--narrow">Zurück zum Menü</a>

</div>

<script>
const ranksInitial = {{ ranks|tojson|safe }};
let ranks = [...ranksInitial];
let currentIndex = 0;
const ranksOriginal = [...ranksInitial];

const flipContainer = document.querySelector(".card-flip");
const img = document.getElementById("rank-image");
const title = document.getElementById("rank-title");
const desc = document.getElementById("rank-desc");

function flipCard() {
  flipContainer.classList.toggle("is-flipped");
}

function updateCard() {
  const rank = ranks[currentIndex];
  img.src = `/static/images/${rank.image_filename}`;
  img.alt = rank.title;
  title.innerText = rank.title;
  desc.innerText = rank.description;
  document.getElementById("rank-abbr").innerText = rank.abbreviation || "-";
  document.getElementById("rank-group").innerText = rank.rank_group || rank.rank_type || "-";
  document.getElementById("rank-nato").innerText = rank.level_code || "-";
}

function nextCard() {
  flipContainer.classList.remove("is-flipped");
  currentIndex = (currentIndex + 1) % ranks.length;
  updateCard();
}

function prevCard() {
  flipContainer.classList.remove("is-flipped");
  currentIndex = (currentIndex - 1 + ranks.length) % ranks.length;
  updateCard();
}

function shuffleCards() {
  for (let i = ranks.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [ranks[i], ranks[j]] = [ranks[j], ranks[i]];
  }
  currentIndex = 0;
  updateCard();
  triggerShake();
}

function resetCards() {
  ranks = [...ranksOriginal];
  currentIndex = 0;
  updateCard();
  triggerShake();
}

function triggerShake() {
  flipContainer.classList.add("shake");
  setTimeout(() => flipContainer.classList.remove("shake"), 400);
}
</script>
{% endblock %}