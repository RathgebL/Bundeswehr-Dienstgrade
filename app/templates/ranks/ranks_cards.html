{% extends "base/base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/ranks_cards.css') }}">
{% endblock %}

{% block content %}
<div class="ranks-cards page-box">
  <h1 class="ranks-cards__title heading-primary">Karteikarten</h1>

  <!-- Filterbereich -->
  <div class="ranks-cards__filter">
    <form method="get" action="{{ url_for('ranks.ranks_cards') }}">
      <label for="branch">Truppenteil:</label>
      <select name="branch" id="branch" class="select" onchange="this.form.submit()">
        <option value="Alle" {% if selected_branch == 'Alle' %}selected{% endif %}>Alle</option>
        <option value="Heer" {% if selected_branch == 'Heer' %}selected{% endif %}>Heer</option>
        <option value="Luftwaffe" {% if selected_branch == 'Luftwaffe' %}selected{% endif %}>Luftwaffe</option>
        <option value="Marine" {% if selected_branch == 'Marine' %}selected{% endif %}>Marine</option>
      </select>
    </form>
  </div>

  <!-- Karte -->
  <div id="flashcard" class="flashcard">
    <div class="flashcard__flip" onclick="flipCard()">
      <div class="flashcard__face flashcard__face--front">
        <img id="rank-image"
             src="{{ url_for('static', filename='images/' + ranks[0].image_filename) }}"
             alt="{{ ranks[0].title }}"
             class="rank-image">
        <p class="flashcard__hint">Klick zum Umdrehen</p>
      </div>

      <div class="flashcard__face flashcard__face--back">
        <h4 id="rank-title" class="rank-title">{{ ranks[0].title }}</h4>
        <div id="rank-meta" class="rank-meta">
          <p id="rank-abbr">{{ ranks[0].abbreviation or "-" }}</p>
          <p id="rank-group">{{ ranks[0].rank_group or ranks[0].rank_type or "-" }}</p>
          <p id="rank-nato">{{ ranks[0].level_code or "-" }}</p>
        </div>
        <p id="rank-desc" class="rank-desc">{{ ranks[0].description }}</p>
      </div>
    </div>
  </div>

  <!-- Steuerung -->
  <div class="ranks-cards__buttons">
    <div class="ranks-cards__controls">
      <button class="btn-card" onclick="prevCard()">Vorherige Karte</button>
      <button class="btn-card" onclick="nextCard()">N채chste Karte</button>
    </div>

    <div class="ranks-cards__controls">
      <button class="btn-card-secondary" onclick="shuffleCards()">Mischen</button>
      <button class="btn-card-secondary" onclick="resetCards()">Ordnen</button>
    </div>
  </div>

  <!-- Zur체ck -->
  <div class="btn-back-container">
    <a href="{{ url_for('ranks.ranks_menu') }}" class="btn btn--secondary">Zur체ck zum Men체</a>
  </div>
</div>

<script>
const ranksInitial = {{ ranks|tojson|safe }};
let ranks = [...ranksInitial];
let currentIndex = 0;
const ranksOriginal = [...ranksInitial];

const flipContainer = document.querySelector(".flashcard__flip");
const img = document.getElementById("rank-image");
const title = document.getElementById("rank-title");
const desc = document.getElementById("rank-desc");

function flipCard() {
  flipContainer.classList.toggle("is-flipped");
}

function updateCard() {
  const rank = ranks[currentIndex];
  img.src = `/static/images/${rank.image_filename}`;
  img.alt = rank.title;
  title.innerText = rank.title;
  desc.innerText = rank.description;
  document.getElementById("rank-abbr").innerText = rank.abbreviation || "-";
  document.getElementById("rank-group").innerText = rank.rank_group || rank.rank_type || "-";
  document.getElementById("rank-nato").innerText = rank.level_code || "-";
}

function nextCard() {
  flipContainer.classList.remove("is-flipped");
  currentIndex = (currentIndex + 1) % ranks.length;
  updateCard();
}

function prevCard() {
  flipContainer.classList.remove("is-flipped");
  currentIndex = (currentIndex - 1 + ranks.length) % ranks.length;
  updateCard();
}

function shuffleCards() {
  for (let i = ranks.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [ranks[i], ranks[j]] = [ranks[j], ranks[i]];
  }
  currentIndex = 0;
  updateCard();
  flipContainer.classList.add("shake");
  setTimeout(() => flipContainer.classList.remove("shake"), 400);
}

function resetCards() {
  ranks = [...ranksOriginal];
  currentIndex = 0;
  updateCard();
  flipContainer.classList.add("reset-glow");
  setTimeout(() => flipContainer.classList.remove("reset-glow"), 400);
}
</script>
{% endblock %}